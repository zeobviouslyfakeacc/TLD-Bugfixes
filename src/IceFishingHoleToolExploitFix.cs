using Harmony;
using UnityEngine;

namespace TLD_Bugfixes {

	/*
	 * When a player cancels clearing an ice fishing hole, the hole is still partially cleared,
	 * but the used tool doesn't degrade.
	 *
	 * This can be exploited like this:
	 * 1. Start clearing an ice fishing hole, but cancel when the progress bar reaches 90%
	 * 2. Repeat the first step once
	 * 3. Now clear the ice fishing hole completely
	 *
	 * Steps 1 and 2 will have cleared the ice fishing hole by 99% without damaging the
	 * used tool. Step 3 only damages the tool for the remaining 1% of the fishing hole it cleared.
	 */

	[HarmonyPatch(typeof(Panel_IceFishingHoleClear), "OnBreakIceComplete")]
	internal static class IceFishingHoleToolExploitFix {

		private static void Prefix(bool success, float progress, GearItem ___m_ToolUsed, IceFishingHole ___m_IceFishingHole) {
			if (!success && ___m_ToolUsed) {
				float clearedRatio = Mathf.Clamp01(___m_IceFishingHole.GetNormalizedFrozen() * progress);
				float toolDamage = ___m_ToolUsed.m_IceFishingHoleClearItem.m_HPDecreaseToClear * clearedRatio;
				___m_ToolUsed.Degrade(toolDamage);
			}
		}
	}
}
